trigger:
  branches:
    include:
      - main

jobs:
  - job: deploy
    displayName: 'Deploy to Salesforce Orgs'
    pool:
      vmImage: 'windows-latest'  # Use windows-latest as you are using Windows

    steps:
      # Step 1: Checkout the repository
      - checkout: self
        displayName: 'Checkout repository'

      # Step 2: Install Salesforce CLI
      - script: |
          curl -sL https://developer.salesforce.com/media/salesforce-cli/install-sfdx-cli.sh | bash
          echo "Salesforce CLI installed"
        displayName: 'Install Salesforce CLI'

      # Step 3: Set Salesforce CLI Path
      - script: |
          echo "Adding Salesforce CLI to PATH..."
          echo "##vso[task.setvariable variable=PATH]C:\Program Files\sf\bin;$(PATH)"
          echo "Updated PATH: $(PATH)"
          sfdx --version  # Verify Salesforce CLI is available
        displayName: 'Set Salesforce CLI Path'

      # Step 4: Authenticate to DevOrg using the secret
      - script: |
          echo $(DEVORG_SFDX_AUTH_URL) > auth-url.txt
          sfdx auth:sfdxurl:store --sfdxurlfile auth-url.txt
        displayName: 'Authenticate to DevOrg'

      # Step 5: Deploy to DevOrg
      - script: |
          sfdx force:source:deploy -p force-app --targetusername DevOrg --checkonly --testlevel RunLocalTests
        displayName: 'Deploy to DevOrg'

      # Step 6: Authenticate to UatOrg using the secret
      - script: |
          echo $(UATORG_SFDX_AUTH_URL) > auth-url.txt
          sfdx auth:sfdxurl:store --sfdxurlfile auth-url.txt
        displayName: 'Authenticate to UatOrg'

      # Step 7: Deploy to UatOrg
      - script: |
          sfdx force:source:deploy -p force-app --targetusername UatOrg --checkonly --testlevel RunLocalTests
        displayName: 'Deploy to UatOrg'

      # Optional Step: Commit and push changes (if needed)
      - script: |
          git config --local user.email "your-email@example.com"
          git config --local user.name "Your Name"
          git add .
          git commit -m "Deploy changes to both DevOrg and UatOrg"
          git push
        env:
          GITHUB_TOKEN: $(GITHUB_TOKEN)
        displayName: 'Commit and push changes'
