name: Salesforce CI/CD Pipeline

# Trigger the workflow on push to the main branch
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest  # Specify the runner as Windows-based

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          curl -sL https://developer.salesforce.com/media/salesforce-cli/install-sfdx-cli.sh | bash
          echo "Salesforce CLI installed"

      # Step 3: Add Salesforce CLI to PATH
      - name: Set Salesforce CLI Path
        run: |
          echo "Adding Salesforce CLI to PATH..."
          set PATH=%PATH%;C:\Program Files\sf\bin
          echo "Updated PATH: %PATH%"
          sfdx --version  # Verify Salesforce CLI is available

      # Step 4: Authenticate to DevOrg using the secret
      - name: Authenticate to DevOrg
        run: |
          echo $(DEVORG_SFDX_AUTH_URL) > auth-url.txt
          sfdx auth:sfdxurl:store --sfdxurlfile auth-url.txt

      # Step 5: Deploy to DevOrg
      - name: Deploy to DevOrg
        run: |
          sfdx force:source:deploy -p force-app --targetusername DevOrg --checkonly --testlevel RunLocalTests

      # Step 6: Authenticate to UatOrg using the secret
      - name: Authenticate to UatOrg
        run: |
          echo $(UATORG_SFDX_AUTH_URL) > auth-url.txt
          sfdx auth:sfdxurl:store --sfdxurlfile auth-url.txt

      # Step 7: Deploy to UatOrg
      - name: Deploy to UatOrg
        run: |
          sfdx force:source:deploy -p force-app --targetusername UatOrg --checkonly --testlevel RunLocalTests

      # Optional Step: Commit and push changes (if needed)
      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "your-email@example.com"
          git config --local user.name "Your Name"
          git add .
          git commit -m "Deploy changes to both DevOrg and UatOrg"
          git push
